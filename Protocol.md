# Surviveler protocol

The surviveler protocol is based on TCP transport.

## General packet structure

The following one is the general structure of the surviveler protocol structure
both in client->server communication and in server->client communication.

    +---------+
    | msgtype |
    +---------+
    | size    |
    +---------+
    | payload |
    +---------+

 * **msgtype** (2 bytes unsigned short): the type of the message: a
 comprehensive list of msgtypes is available in client/src/message.py
 (MessageType enum) in network-byte-order.

 * **size** (4 bytes unsigned int): the size in bytes of the payload in
 network-byte-order.

 * **payload** (N bytes): the msgpack-encoded message payload containing the
 whole information needed for the message (examples below).

--------------------------------------------------------------------------------

## Message types

### Ping (type 0)

The **ping** message type (type *0*) is used (along with the **pong**) to sync
the client time with the server one. After a sync, the client is able to
calculate on his own how to interpret the *state* data received from the server
regardless of eventual lags or huge ping time.

*This message is only generated by the client.*

The **ping** payload contains the following data:

```json
{
  "Id": 1234
}
```
 * **Id** (4 bytes unsigned int) is an incremental number generated by the
 client and used by it to ideitify the **pong** response from the server (in
 case of multiple *ping* requests)

--------------------------------------------------------------------------------

### Pong (type 1)

The **pong** message type (type *1*) is used (along with the **ping**) to sync
the client time with the server one. After a sync, the client is able to
calculate on his own how to interpret the *state* data received from the server
regardless of eventual lags or huge ping time.

*This message is only generated by the server.*

The **ping** payload contains the following data:

```json
{
  "Id": 1234,
  "Tstamp": 12345678
}
```

 * **Id** (4 bytes unsigned int) is an incremental number generated by the client
 and used by it to ideitify the **pong** response from the server (in case of
 multiple *ping* requests)

 * **Tstamp** (8 bytes int) in his current acception is the number of
 milliseconds after epoch calculated on the server (UTC). We use this just to
 create the timedelta inside the client and sync the operations so it can be
 relative from whatever reference time available from the server (*like when the
 server started his execution*).

--------------------------------------------------------------------------------

### Gamestate (type 2)

The **gamestate** message type (type *2*) is used to transmit the game state
from the server to the clients.

*This message is only generated by the server.*

The **gamestate** payload contains the following data:

```json
{
  "Tstamp": 12345678,
  "Xpos": 10.0,
  "Ypos": 15.0,
  "ActionType": 1,
  "Action": {
    "Xpos": 5.0,
    "Ypos": 7.5,
    "Speed": 2
  }
}
```
 * **Tstamp** (8 bytes int) in his current acception is the number of
 milliseconds after epoch calculated on the server (UTC). This the offset to the
 original Tstamp sent by the server during the **pong**, and is going to be used
 to compute the advancement at the time the packet arrives to the client.

 * **Xpos** (4 bytes float) the x-axis position in game units of the center
 of the entity in the board.

 * **Ypos** (4 bytes float) the y-axis position in game units of the center
 of the entity in the board.

 * **ActionType** (2 bytes unsigned short) the id of the action that the entity
 (the player, right now) is performing.

 * **Action** (dict) the actual payload of the action. This is potentially
 different for every action type.

#### The following action types are already implemented and their own payload:

##### Action 0 - Idle

The entity is doing *absolutely nothing*. The payload for this action is an
empty dictionary.

```json
{}
```

##### Action 1 - Move

The entity is moving. All the information about the movement are inside the
payload. This payload has always the following structure:

```json
{
  "Xpos": 5.0,
  "Ypos": 7.5,
  "Speed": 2
}
```

 * **Xpos** (4 bytes float) the x-axis position in game units of the center
 of the entity at the end of the movement (ie. *x-axis destination*).

 * **Ypos** (4 bytes float) the y-axis position in game units of the center
 of the entity at the end of the movement (ie. *y-axis destination*).

 * **Speed** (4 bytes float) the speed of the entity in `game unit/sec`.

--------------------------------------------------------------------------------

### Move (type 3)

The **move** message type (type *3*) is used to communicate the intention to
move the player entity to the server.

*This message is only generated by the client.*

The **move** payload contains the following data:

```json
{
  "Xpos": 5.0,
  "Ypos": 7.5,
}
```

 * **Xpos** (4 bytes float) the x-axis position in game units of the center
 of the entity at the end of the movement (ie. *x-axis destination*).

 * **Ypos** (4 bytes float) the y-axis position in game units of the center
 of the entity at the end of the movement (ie. *y-axis destination*).
